#region using
	using Convert = System.Convert;
	using Network;
	using Newtonsoft.Json;
	using System;
	using System.Collections.Generic;
	using System.Collections;
	using System.Linq;
	using System.Text;
	using Oxide.Core.Libraries.Covalence;
	using Oxide.Plugins;
	using Oxide.Core.Plugins;
	using Oxide.Core;
	using UnityEngine; 
	using UnityEngine.SceneManagement;
	using UnityEngine.AI;
	using Rust.Ai;
	using Oxide.Ext.RustEdit;
#endregion
namespace Oxide.Plugins{
	[Info("Hotzone", "obsol", "0.0.1")]
	[Description("Makes all scientist brains move towards a specified point on the map")]
	public class Hotzone : CovalencePlugin{	
		#region Generic Vars
		private Game.Rust.Libraries.Player _rustPlayer = Interface.Oxide.GetLibrary<Game.Rust.Libraries.Player>("Player");
		#endregion
		#region Configuration
		private Configuration config;
		private void Init(){
			permission.RegisterPermission("hotzone.set", this);
		}		
		class Configuration{
			[JsonProperty("target", ObjectCreationHandling = ObjectCreationHandling.Replace)]
			public Vector3 target;
			[JsonProperty("factionLib", ObjectCreationHandling = ObjectCreationHandling.Replace)]
			public Dictionary<ulong, Dictionary<FactionController.FactionType,float>> factionLib=new Dictionary<ulong, Dictionary<FactionController.FactionType,float>>();
			[JsonProperty("pointGroups", ObjectCreationHandling = ObjectCreationHandling.Replace)]		
			public Dictionary<string,List<Vector3>> pointGroups = new Dictionary<string,List<Vector3>>();
			public string ToJson() => JsonConvert.SerializeObject(this);				
			public Dictionary<string, object> ToDictionary() => JsonConvert.DeserializeObject<Dictionary<string, object>>(ToJson());
		}
		protected override void LoadDefaultConfig() => config = new Configuration();
		protected override void LoadConfig(){
			base.LoadConfig();
			try{
				config = Config.ReadObject<Configuration>();
				if (config == null) throw new JsonException();
				if (!config.ToDictionary().Keys.SequenceEqual(Config.ToDictionary(x => x.Key, x => x.Value).Keys)){
					LogWarning("Configuration appears to be outdated; updating and saving");SaveConfig();}
			}
			catch{LogWarning($"Configuration file {Name}.json is invalid; using defaults");LoadDefaultConfig();}
			FactionController.factionScores = config.factionLib;
		}
		protected override void SaveConfig(){
			LogWarning($"Configuration changes saved to {Name}.json");
			config.factionLib=FactionController.factionScores;
			Config.WriteObject(config, true);
		}
		#endregion Configuration
		#region Faction logic		
			#region Utility
			public BaseEntity getLookingAt(BasePlayer player){			
				RaycastHit hit;
				if (Physics.Raycast(player.eyes.HeadRay(), out hit)){
					var entity = hit.GetEntity();
					if (entity != null){if(entity.GetComponent<BaseEntity>()!=null) return entity.GetComponent<BaseEntity>();}
				}
				return null;
			}
			#endregion
			#region Chat commands
			[Command("hz_set")] private void surv_hotzone(IPlayer player, string command, string[] args){
				BasePlayer bp = (BasePlayer)player.Object;
				if(player.HasPermission("hotzone.set")){
					config.target=bp.transform.position;				
					SendChatMsg(bp,"Target set!" + config.target.ToString());
					SaveConfig();
				}
				else SendChatMsg(bp,"Missing permission!");
			
			}
			[Command("hz_get")] private void surv_info(IPlayer player, string command, string[] args){				
				BasePlayer bp = (BasePlayer)player.Object;
				FactionController fc = bp.GetComponent<FactionController>();
				SendChatMsg(bp,"Current Position:" + bp.transform.position.ToString());
				SendChatMsg(bp,"Current Target:" + config.target.ToString());
				SendChatMsg(bp,"Current Distance:" + Vector3.Distance(config.target,bp.transform.position).ToString());
				if(fc==null) return;
				SendChatMsg(bp,"Current Faction:"+bp.GetComponent<FactionController>().faction.ToString());
				foreach(KeyValuePair<FactionController.FactionType,float> ff in FactionController.factionScores[bp.userID]){
					SendChatMsg(bp,ff.Key.ToString() + ":" + ff.Value.ToString());
				}	
				
			}
			[Command("hz_save")] private void surv_save(IPlayer player, string command, string[] args){		
				BasePlayer bp = (BasePlayer)player.Object;
				SaveConfig();
				SendChatMsg(bp,"Saving!");
								
			}
			[Command("hz_reset")] private void surv_reset(IPlayer player, string command, string[] args){	
				foreach(HumanNPC hn in GameObject.FindObjectsOfType<HumanNPC>()){
					if(hn.GetComponent<FactionController>()!=null){
						GameObject.Destroy(hn.GetComponent<FactionController>());
					}
					swapSciRoamState(hn);		
				}					
			}
			public void addPointToGroup(){}
			#endregion chatcmds
			//Oxide.Ext.RustEdit.NPC.NPCSpawner
			#region Faction Initializers
			void OnPlayerRespawned(BasePlayer player)=>initPlayer(player);
			void OnPlayerSleepEnded(BasePlayer player)=>initPlayer(player);
			void OnPlayerDisconnected(BasePlayer player, string reason)=>SaveConfig();
			object OnNPCAIInitialized(BaseAIBrain<HumanNPC> player){swapSciRoamState(player.GetComponent<HumanNPC>()); return null;}
			object OnPlayerDeath(BasePlayer player, HitInfo info){SaveConfig(); return null;}
			private void swapSciRoamState(HumanNPC s){
				if(s.IsNpc)Puts(((char)27)+"[96m"+"IsNpc! Did you fix NPCPlayer with dnSpy?");
				//Puts(s.spawnPos.ToString());
				if(s.Brain==null) return;
				s.Brain.Senses.senseTypes = (EntityType)67;
				s.Brain.Senses.hostileTargetsOnly = false;
				FactionController fc = s.gameObject.AddComponent<FactionController>();
				fc.faction=FactionController.FactionType.Bandit;
				fc.self=s;
				if(s.transform.name.ToLower().Contains("scientist")) 
					fc.faction=FactionController.FactionType.Scientist;
				BaseNavigator bn = s.gameObject.GetComponent<BaseNavigator>();
			}
			void initPlayer(BasePlayer player){
				FactionController fc = player.gameObject.AddComponent<FactionController>();
				FactionController.changeScore(player, FactionController.FactionType.Both, 0.005f);
				FactionController.changeScore(player, FactionController.FactionType.Scientist, 0f);
				FactionController.changeScore(player, FactionController.FactionType.Bandit, 0f);
				SaveConfig();
			}
			#endregion initializers
			#region Faction NPC Handlers
			object OnAttackedAIEvent(AttackedAIEvent aievent, BasePlayer bp){	
				//Puts("OnAttackedAIEvent");
				if(bp==null)return null;
				FactionController shooter = bp.gameObject.GetComponent<FactionController>();
				FactionController victim = aievent.combatEntity.gameObject.GetComponent<FactionController>();
				//Puts("OnAttackedAIEvent2");
				if(shooter==null || victim==null) return null;
				//Puts(shooter.faction.ToString() + " : " + victim.faction.ToString());
				if(shooter.self==null) return null;
				//Puts("Shooter is NPC");
				BaseNavigator bn = aievent.combatEntity.gameObject.GetComponent<BaseNavigator>();
				if(bn!=null){
					bn.SetDestination(new Vector3(0,0,0));
				}
				if(FactionController.validTarget(victim.GetComponent<BasePlayer>(),bp)) return null;
				aievent.combatEntity.lastAttacker=null;
				//Puts("Same Team");
				return victim;
			}
			object OnBasePlayerAttacked(BasePlayer victimbp, HitInfo info){
				//Puts("OnBasePlayerAttacked");
				if(victimbp==null)return null;
				FactionController victim = victimbp.gameObject.GetComponent<FactionController>();
				FactionController shooter = info.Initiator.gameObject.GetComponent<FactionController>();
				//Puts("OnBasePlayerAttacked");
				if(shooter==null || victim==null) return null;
				//Puts(shooter.faction.ToString() + " : " + victim.faction.ToString());
				BaseNavigator bn = victimbp.GetComponent<BaseNavigator>();
				if(bn!=null){
					bn.SetDestination(new Vector3(0,0,0));
				}
				if(shooter.self==null) return null;
				//Puts("Shooter is NPC");
				if(FactionController.validTarget(shooter.GetComponent<BasePlayer>(),victimbp)) return null;
				//Puts("Same Team");
				return victim;
			}
			object OnEntityTakeDamage(BaseCombatEntity entity, HitInfo info){
				if(info.HitEntity==null||info.Initiator==null) return null;
				if(info.HitEntity.gameObject==null||info.Initiator.gameObject==null) return null;
				FactionController shooter = info.Initiator.GetComponent<FactionController>();
				FactionController victim = info.HitEntity.gameObject.GetComponent<FactionController>();
				if(shooter!=null&&victim!=null){//
					if(shooter.self==null){
						BasePlayer bp = shooter.GetComponent<BasePlayer>();
						FactionController.changeScore(bp, victim.faction, -0.1f);
						FactionController.changeScore(bp, FactionController.FactionType.Both, -0.1f);
						if(victim.faction==FactionController.FactionType.Scientist)
							FactionController.changeScore(bp, FactionController.FactionType.Bandit, +0.005f);
						if(victim.faction==FactionController.FactionType.Bandit)
							FactionController.changeScore(bp, FactionController.FactionType.Scientist, +0.005f);
					}						
										
					if(shooter.faction==victim.faction){
						if(shooter.self==null){
							//Puts("Same team player, halving!");	
							info.damageTypes.ScaleAll(0.5f);
							return new object();
						}
						else{
							//Puts("Same team NPCs, ignoring!");
							return new object();
						}
						
					}
				}
				return null;
			}
			bool? OnIsThreat(HumanNPC hn, BaseEntity be){
				BasePlayer bp = be.GetComponent<BasePlayer>();
				if(bp == null){return false;}
				return (FactionController.validTarget((BasePlayer)hn,bp));
			}
			bool? OnIsTarget(HumanNPC hn, BaseEntity be){
				BasePlayer bp = be.GetComponent<BasePlayer>();
				if(bp == null){return false;}
				return (FactionController.validTarget((BasePlayer)hn,bp));
			}
			bool? OnIsFriendly(HumanNPC hn, BaseEntity be){/*
			if(hn.Brain.Senses.owner.transform.name==be.transform.name) return true;*/
				BasePlayer bp = be.GetComponent<BasePlayer>();
				if(bp == null){return true;}
				return !(FactionController.validTarget((BasePlayer)hn,bp));
			}
			bool? OnCaresAbout(AIBrainSenses hn, BaseEntity be){
				//*
				if(
					((be.GetComponent<BasePlayer>()==null))
					&& ((be.GetComponent<BaseNpc>()==null))
					) return false;
				if(be.GetComponent<BasePlayer>()!=null && hn.owner.GetComponent<BaseNpc>()!=null){
					if (be.GetComponent<BasePlayer>().IsConnected) return true;
					//else return false;
				}
				//*/
				return FactionController.validTarget(hn.owner, be);
			}
			/*
			Assign points by faction
			Walk towards closest point
			if in range of point, next point. If stuck, next list
			Follow point chain indefinitely
			if all lists exhausted, fall into random roam
			*/
			#endregion
			#region NPC destination handlers
			Vector3? OnGetRoamAnchorPosition(BaseAIBrain<HumanNPC> bn){
				BaseAIBrain<HumanNPC>.BasicAIState cs = bn.CurrentState;
				if(cs!=null){
						if(config.target!= new Vector3(0,0,0)){
							if(Vector3.Distance(config.target,bn.transform.position)<70f){
								//Puts("Destination set " +pos.ToString()+":"+ target.ToString());
								return bn.transform.position;
							}
							return config.target;							
						}
				}
				return null;
			}
			#endregion
		#endregion
		private Vector3 repulsePoint(Vector3 t1, Vector3 t2){
			float factor=750f;//This is a guess, viva desmos
			float Distance = Vector3.Distance(t1,t2);
			return t1-((t2-t1)/(Distance/factor));
		}
		
		private void OnServerInitialized()
        {
			LoadConfig();
			
            timer.Every(7f, () => {
				
			}
		}
		private void OnItemUse(Item i, int n)
        {
			if(i.ToString().Contains("cactus")){
				
				SaveConfig();
			}
		}
		private void DSFDF(){
			foreach(FactionController fc in GameObject.FindObjectsOfType<FactionController>()){					
				if(fc.self.Brain!=null){
					Puts(fc.self.Brain.GetType().ToString()+":"+fc.self.Brain.CurrentState.ToString());
					if(fc.self.Brain.CurrentState.ToString().Contains("Idle") || fc.self.Brain.CurrentState.ToString().Contains("BaseFollowPathState")){							
						Vector3 AB = config.pointGroups[fc.squad][fc.PointIndex]- fc.self.transform.position;
						AB = Vector3.Normalize(AB);
						Vector3 position = fc.self.transform.position+(new Vector3(AB.x,0,AB.z)*50);
						fc.self.Brain.Navigator.SetDestination(position);		
					}
				}
			}
		}
		
		public class FactionController : MonoBehaviour{
			public enum FactionType{
				None,
				Scientist,
				Bandit,
				Both
			}
			
			public FactionType faction;
			public static Dictionary<ulong, Dictionary<FactionType,float>> factionScores = 
				new Dictionary<ulong, Dictionary<FactionType,float>>();
			public static Dictionary<string,List<FactionController>>() squads = new Dictionary<string,List<>>();
			
			public List<Vector3> ActivePointGroup = new List<Vector3>();
			public string squad = "Demo";
			public int PointIndex;
			public HumanNPC self;
			
			public static bool changeScore(BasePlayer bp, FactionType ft, float score){
				try{
					if(bp==null)return false;
					if(ft==null)return false;
					FactionController fc = bp.GetComponent<FactionController>();
					if(fc==null)fc=bp.gameObject.AddComponent<FactionController>();
					ulong id= bp.userID;
					if(factionScores==null) return false;
					Dictionary<FactionType,float> selfFactions;
						factionScores.TryGetValue(id,out selfFactions);
					if(selfFactions==null) factionScores.Add(id, new Dictionary<FactionType,float>());
					float oldScore;//
					if(!(selfFactions.TryGetValue(ft,out oldScore))){
						oldScore=0.0f;
						selfFactions.Add(ft,oldScore);
					}
					oldScore+=score;
					factionScores[id][ft]=oldScore;
					if(factionScores[id][ft]>1)factionScores[id][ft]=1;
					if(factionScores[id][ft]<-1)factionScores[id][ft]=-1;
					float maxScore =-2f;
					List<FactionType> activeFactions = new List<FactionType>();
					foreach(KeyValuePair<FactionType,float> f in factionScores[id]){
						if(f.Value>0 && f.Key!=FactionType.None){
							maxScore=f.Value;
							activeFactions.Add(f.Key);
						}
					}
					switch(activeFactions.Count()){
						case 0 :
							fc.faction=FactionType.None;
							break;
						case 1 :
							fc.faction=activeFactions[0];
							break;
						default :
							fc.faction=FactionType.Both;
							break;
					}
					return true;
				}catch(Exception e){return false;}
			}
			public static bool validTarget(BaseEntity self, BaseEntity basetarget){
			
				FactionController selfFC = self.GetComponent<FactionController>();
				FactionController targetFC = basetarget.GetComponent<FactionController>();
				if(selfFC!=null&&targetFC!=null){
					bool result =  (!(targetFC.faction==FactionType.Both) && (
						targetFC.faction==FactionType.None ||
						selfFC.faction != targetFC.faction));
					return result;
				}else{}
				return false;
			}
		}
	}
}	//*/